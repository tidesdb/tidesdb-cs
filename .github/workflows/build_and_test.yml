name: TidesDB C# CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
          - os: macos-latest
            name: macOS x64
          - os: windows-latest
            name: Windows x64

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}

    steps:
      - name: Checkout tidesdb-cs repo
        uses: actions/checkout@v4
        with:
          repository: tidesdb/tidesdb-cs
          path: tidesdb-cs

      - name: Checkout tidesdb repo
        uses: actions/checkout@v4
        with:
          repository: tidesdb/tidesdb
          path: tidesdb

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y libzstd-dev liblz4-dev libsnappy-dev build-essential cmake pkg-config

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install zstd lz4 snappy

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg install zstd:x64-windows lz4:x64-windows snappy:x64-windows pthreads:x64-windows

      - name: Configure and build TidesDB (Linux)
        if: runner.os == 'Linux'
        run: |
          cd tidesdb
          cmake -S . -B build -DTIDESDB_BUILD_TESTS=OFF -DTIDESDB_WITH_SANITIZER=OFF
          cmake --build build --config Release
          sudo cmake --install build
          sudo ldconfig

      - name: Configure and build TidesDB (macOS)
        if: runner.os == 'macOS'
        run: |
          cd tidesdb
          export HOMEBREW_PREFIX=$(brew --prefix)
          cmake -S . -B build \
            -DTIDESDB_BUILD_TESTS=OFF \
            -DTIDESDB_WITH_SANITIZER=OFF \
            -DCMAKE_PREFIX_PATH="${HOMEBREW_PREFIX}"
          cmake --build build --config Release
          sudo cmake --install build

      - name: Configure and build TidesDB (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd tidesdb
          cmake -S . -B build `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DBUILD_SHARED_LIBS=ON `
            -DTIDESDB_WITH_SANITIZER=OFF `
            -DTIDESDB_BUILD_TESTS=OFF `
            -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS=ON
          cmake --build build --config Release
          # Copy DLL and dependencies to a known location
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/tidesdb-bin"
          Copy-Item build/Release/tidesdb.dll -Destination "${{ github.workspace }}/tidesdb-bin/" -Force
          # Copy vcpkg dependency DLLs
          Copy-Item "${{ github.workspace }}/vcpkg/installed/x64-windows/bin/*.dll" -Destination "${{ github.workspace }}/tidesdb-bin/" -Force
          Get-ChildItem "${{ github.workspace }}/tidesdb-bin/"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd tidesdb-cs
          dotnet restore

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd tidesdb-cs
          dotnet build --no-restore

      - name: Run tests (Linux)
        if: runner.os == 'Linux'
        run: |
          cd tidesdb-cs
          dotnet test --no-build --verbosity normal

      - name: Run tests (macOS)
        if: runner.os == 'macOS'
        run: |
          cd tidesdb-cs
          export DYLD_LIBRARY_PATH=/usr/local/lib:$DYLD_LIBRARY_PATH
          dotnet test --no-build --verbosity normal

      - name: Restore dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd tidesdb-cs
          dotnet restore

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd tidesdb-cs
          dotnet build --no-restore

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd tidesdb-cs
          # Copy native DLLs to test output directory (created by build step)
          $testDir = "tests\TidesDB.Tests\bin\Debug\net8.0"
          Write-Host "Test directory contents before copy:"
          Get-ChildItem $testDir -ErrorAction SilentlyContinue
          Copy-Item "${{ github.workspace }}\tidesdb-bin\*.dll" -Destination $testDir -Force
          Write-Host "Test directory contents after copy:"
          Get-ChildItem $testDir
          # Run without --no-build to ensure all assemblies are properly resolved
          dotnet test --verbosity normal
